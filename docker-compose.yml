version: '3.8'

services:
  # ============ Nacos 服务注册中心 ============
  nacos:
    image: nacos/nacos-server:v2.2.0
    container_name: nacos-server
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=nacos
      - MYSQL_SERVICE_PASSWORD=nacos
      - NACOS_AUTH_ENABLE=false
      - JVM_XMS=512m
      - JVM_XMX=512m
      - JVM_XMN=256m
    ports:
      - "8848:8848"
      - "9848:9848"
    depends_on:
      - mysql
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ MySQL 数据库 ============
  mysql:
    image: mysql:8.0
    container_name: mysql-server
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: nacos
      MYSQL_USER: nacos
      MYSQL_PASSWORD: nacos
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ Sentinel 仪表盘 ============
  sentinel:
    image: bladex/sentinel-dashboard:latest
    container_name: sentinel-dashboard
    ports:
      - "8858:8858"
    environment:
      - TZ=Asia/Shanghai
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8858/" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ 微服务 - service-product (Feign版本) ============
  service-product:
    build:
      context: ./services/service-product
      dockerfile: Dockerfile
    container_name: service-product
    environment:
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_USERNAME=nacos
      - NACOS_PASSWORD=nacos
      - NACOS_NAMESPACE=8699ba10-d5ae-4183-aa94-eef36789f4d3
    ports:
      - "8010:8010"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8010/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ 微服务 - service-product-dubbo (Dubbo版本) ============
  service-product-dubbo:
    build:
      context: ./services/service-product-dubbo
      dockerfile: Dockerfile
    container_name: service-product-dubbo
    environment:
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_USERNAME=nacos
      - NACOS_PASSWORD=nacos
      - NACOS_NAMESPACE=8699ba10-d5ae-4183-aa94-eef36789f4d3
    ports:
      - "8011:8011"
      - "20881:20881"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8011/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ 微服务 - service-order (Feign版本) ============
  service-order:
    build:
      context: ./services/service-order
      dockerfile: Dockerfile
    container_name: service-order
    environment:
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_USERNAME=nacos
      - NACOS_PASSWORD=nacos
      - NACOS_NAMESPACE=8699ba10-d5ae-4183-aa94-eef36789f4d3
      - SENTINEL_DASHBOARD=sentinel:8858
    ports:
      - "8000:8000"
      - "8719:8719"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/config" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ 微服务 - service-order-dubbo (Dubbo版本) ============
  service-order-dubbo:
    build:
      context: ./services/service-order-dubbo
      dockerfile: Dockerfile
    container_name: service-order-dubbo
    environment:
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_USERNAME=nacos
      - NACOS_PASSWORD=nacos
      - NACOS_NAMESPACE=8699ba10-d5ae-4183-aa94-eef36789f4d3
      - SENTINEL_DASHBOARD=sentinel:8858
    ports:
      - "8001:8001"
      - "20880:20880"
      - "8721:8721"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/api/order/dubbo/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ API 网关 ============
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_USERNAME=nacos
      - NACOS_PASSWORD=nacos
      - NACOS_NAMESPACE=8699ba10-d5ae-4183-aa94-eef36789f4d3
      - SENTINEL_DASHBOARD=sentinel:8858
    ports:
      - "8080:8080"
      - "8720:8720"
    depends_on:
      nacos:
        condition: service_healthy
      service-order:
        condition: service_healthy
      service-product:
        condition: service_healthy
    networks:
      - spring-cloud
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  spring-cloud:
    driver: bridge

volumes:
  mysql-data:
    driver: local
