## Context

本次变更是跨模块的端到端升级，覆盖 `gateway`、`services/*`、`model` 与构建链路。当前项目技术点丰富，但存在三个核心问题：
- 场景定义分散，前端展示、后端实现、验证脚本之间缺少统一事实源，容易接口漂移。
- 环境与构建配置偏“单机定制”，跨机器复现成本高，工具链不一致会直接导致构建失败。
- 关键场景（Seata、Sentinel、Dubbo、Redis）缺少标准化验证证据，难以形成稳定面试演示闭环。

约束条件：
- 需要保留现有模块结构和技术栈（Spring Cloud Alibaba + Dubbo + Seata + Gateway）。
- 变更范围大，必须分阶段推进，确保每阶段都可运行与可验收。
- 高级话题（RocketMQ/Chaos/Higress/OpenSergo/SchedulerX/AppActive）需先完成“状态标注与路线图”，避免误导为已实现。

## Goals / Non-Goals

**Goals:**
- 建立统一场景目录（catalog）与成熟度模型，成为前端页面、后端路由、测试脚本的单一事实源。
- 消除前后端接口契约漂移，保证演示页调用路径与后端真实接口一致。
- 完成配置参数化与本地默认 profile，提供一键环境与可移植运行能力。
- 固化 Java/Maven 版本约束和构建门禁，消除“环境偶然成功”。
- 将超大类按领域拆分并统一公共响应模型，提高可维护性。
- 为核心能力提供可重复验证：单测、集测、冒烟、Seata 前后状态、Sentinel/Dubbo/Redis 场景脚本。
- 建立最小 CI 基线与面试模式演示流，形成“可讲 + 可证据化”的项目形态。
- 落地最小 OpenTelemetry 链路闭环；其他高级话题明确状态与后续计划。

**Non-Goals:**
- 本轮不追求把所有高级话题全部实现为生产级能力。
- 不引入全新微服务框架或重写现有业务逻辑。
- 不在本轮完成全量性能压测平台建设，仅提供可重复的标准化场景脚本。

## Decisions

1. 使用 `scenario-catalog` 作为单一事实源  
选择：新增场景编目文件（包含 capability、endpoint、依赖、成熟度、验证步骤）。  
原因：当前页面配置与后端接口分散在多处，手工维护易漂移。  
备选：继续维护多个配置文件并靠人工同步。  
不选原因：不可扩展，回归成本高，错误发现滞后。

2. 前端配置改为“由 catalog 生成/校验”  
选择：前端路由与按钮所需 endpoint 由 catalog 生成或至少在构建时校验。  
原因：从源头消除接口不一致。  
备选：继续手工编辑 `services-config.js` / `service-demo.js`。  
不选原因：每次改接口都需多点修改，极易漏改。

3. 环境参数化与 profile 分层  
选择：Nacos/Sentinel/Redis/Seata 地址、namespace、端口、凭证统一改为占位变量，默认 `local` 可运行。  
原因：降低迁移成本，避免硬编码。  
备选：保留当前固定配置，仅文档说明。  
不选原因：跨团队/面试现场复现失败概率高。

4. 引入构建前置约束（Enforcer + 最小质量门）  
选择：在 Maven 生命周期前置校验 Java/Maven 版本，构建失败信息显式化。  
原因：工具链不一致是当前高频失败点。  
备选：仅在文档要求安装指定版本。  
不选原因：不具备强制性，易被忽略。

5. 大类拆分采用“控制器薄层 + 领域服务 + 场景编排”  
选择：拆分 OrderController/RedisTestController/ProductDubboClient，按场景域落到独立 service/facade。  
原因：降低单类复杂度，提升测试与演示可维护性。  
备选：维持现状，仅加注释。  
不选原因：维护与定位问题成本持续增高。

6. 公共响应模型统一下沉到 `model`  
选择：统一 `ApiResponse/ResultCode` 语义，模块复用。  
原因：减少重复与行为不一致。  
备选：各模块各自维护。  
不选原因：扩展字段和错误码时会出现分叉。

7. 测试体系分层并绑定场景验收  
选择：单测（规则/兜底）、集测（路由/调用/事务）、冒烟（核心链路）三层。  
原因：覆盖“逻辑正确 + 集成正确 + 演示可用”。  
备选：仅保留现有模块级测试。  
不选原因：无法兜住跨模块回归。

8. Seata 场景采用“状态快照 + 失败注入”验证模式  
选择：在事务入口前后提供状态观测点，并支持失败注入。  
原因：分布式事务最需要可证据化回滚结果。  
备选：只看日志。  
不选原因：日志主观、难自动验收。

9. 高级主题按“实现状态”分层治理  
选择：将 OpenTelemetry 作为本轮唯一必须落地的高级闭环，其余主题先状态化并建立路线图。  
原因：平衡交付范围与可信度。  
备选：所有主题同时实现。  
不选原因：范围过大，拖慢主线交付。

## Risks / Trade-offs

- [风险] 变更跨度大导致迭代周期拉长  
  → Mitigation: 分三阶段交付（可运行一致性 → 场景证据化 → 工程化与可观测性），每阶段设置可验收门。

- [风险] 拆分大类时引入行为回归  
  → Mitigation: 先补回归测试，再进行无行为改变的结构性重构。

- [风险] 场景目录与生成机制初期维护成本上升  
  → Mitigation: 先落“校验模式”，再演进到“生成模式”，降低一次性改造风险。

- [风险] CI 引入后短期内失败率升高  
  → Mitigation: 分层开启门禁（先 build+smoke，再逐步加严覆盖与集成测试）。

- [风险] OTel 引入增加运行依赖复杂度  
  → Mitigation: 先提供最小本地 collector 方案，默认可关闭。

## Migration Plan

1. Phase 1（可运行一致性）
- 建立 scenario-catalog 与成熟度字段。
- 对齐前后端 endpoint，修复演示页不可达接口。
- 完成配置参数化与 `local` profile。
- 引入 Maven Enforcer 并打通本地构建。

2. Phase 2（场景证据化）
- 补齐 Seata 状态快照与失败注入链路。
- 为 Sentinel/Dubbo/Redis 补标准化场景脚本与预期输出。
- 引入冒烟脚本，覆盖核心面试路径。

3. Phase 3（工程化与高级闭环）
- 拆分超大类并统一公共响应模型。
- 补充集成测试并接入 CI 门禁。
- 落地最小 OTel trace 贯通；其余高级主题完成状态分层与路线图发布。

Rollback Strategy:
- 所有变更分阶段合入，按阶段回滚。
- 关键开关（新路由映射、OTel、演示模式）支持 feature toggle。
- 在旧接口保留兼容窗口，避免一次性切断前端调用。

## Open Questions

- scenario-catalog 采用 YAML 还是 JSON 作为主格式，是否需要 schema 校验文件？
- 前端采用“构建时生成配置”还是“运行时读取 catalog”更符合当前静态页面结构？
- Seata 状态快照接口是否需要单独权限控制，防止误暴露敏感数据？
- OTel 最小方案是否内置 collector compose，还是仅提供可选接入说明？
