# Sentinel 系统规则参数详解

本文档详细介绍了 Sentinel 系统规则中各个参数的含义和使用方法。

## 系统规则结构

系统规则是一个 JSON 数组，每个数组元素代表一条系统规则：

```json
[
  {
    "highestSystemLoad": 2.0,
    "qps": -1,
    "avgRt": -1,
    "maxThread": -1,
    "highestCpuUsage": 0.8
  }
]
```

## 参数详解

### 1. highestSystemLoad（系统负载）
- **类型**: Double
- **默认值**: -1（不生效）
- **说明**: 系统自适应限流的系统负载阈值，对应 Linux 中的 Load Average 指标
- **工作原理**: 当系统负载超过设定值时，触发系统保护
- **示例**:
  ```json
  "highestSystemLoad": 2.0  // 系统负载超过2.0时触发保护
  ```

### 2. qps（入口 QPS）
- **类型**: Double
- **默认值**: -1（不生效）
- **说明**: 所有入口流量的 QPS 阈值（每秒请求总数）
- **工作原理**: 当所有入口的总 QPS 超过设定值时，触发系统保护
- **示例**:
  ```json
  "qps": 1000  // 总QPS超过1000时触发保护
  ```

### 3. avgRt（平均响应时间）
- **类型**: Double
- **默认值**: -1（不生效）
- **说明**: 所有入口流量的平均响应时间阈值（毫秒）
- **工作原理**: 当所有入口的平均响应时间超过设定值时，触发系统保护
- **示例**:
  ```json
  "avgRt": 500  // 平均响应时间超过500ms时触发保护
  ```

### 4. maxThread（并发线程数）
- **类型**: Double
- **默认值**: -1（不生效）
- **说明**: 所有入口流量的并发线程数阈值
- **工作原理**: 当所有入口的并发线程数超过设定值时，触发系统保护
- **示例**:
  ```json
  "maxThread": 100  // 并发线程数超过100时触发保护
  ```

### 5. highestCpuUsage（CPU 使用率）
- **类型**: Double
- **默认值**: -1（不生效）
- **说明**: 系统 CPU 使用率阈值（0.0-1.0）
- **工作原理**: 当系统 CPU 使用率超过设定值时，触发系统保护
- **示例**:
  ```json
  "highestCpuUsage": 0.8  // CPU使用率超过80%时触发保护
  ```

## 规则示例解析

### 示例：系统自适应保护
```json
{
  "highestSystemLoad": 2.0,
  "qps": -1,
  "avgRt": -1,
  "maxThread": -1,
  "highestCpuUsage": 0.8
}
```
**解释**: 
- 当系统负载超过 2.0 或 CPU 使用率超过 80% 时触发系统保护
- 其他指标（QPS、平均响应时间、并发线程数）不生效（值为-1）

## 系统保护机制

### 1. Load 即载入
- **指标来源**: Linux Load Average，可通过 `top` 或 `uptime` 命令查看
- **含义**: 系统在特定时间间隔内的平均任务数
- **阈值建议**: 通常设置为 CPU 核心数的 70%-80%

### 2. CPU 使用率
- **指标来源**: 系统 CPU 使用率
- **阈值建议**: 通常设置为 70%-80%，为系统预留缓冲空间

### 3. 入口 QPS
- **指标来源**: 所有 API 入口的总 QPS
- **适用场景**: 适用于对整体流量有明确上限要求的场景

### 4. 平均响应时间
- **指标来源**: 所有 API 的平均响应时间
- **适用场景**: 适用于对整体响应性能有严格要求的场景

### 5. 并发线程数
- **指标来源**: 处理请求的线程总数
- **适用场景**: 适用于需要控制整体并发量的场景

## 最佳实践

### 1. 合理设置阈值
- 根据系统实际承载能力设置阈值
- 预留一定的缓冲空间，避免阈值设置过于激进

### 2. 分层设置保护
- 可以同时设置多个系统保护指标
- 不同指标可以提供不同维度的保护

### 3. 监控与调优
- 持续监控系统指标变化
- 根据实际运行情况调整阈值

## 注意事项

1. **系统规则是全局生效的，会影响整个应用的所有流量**
2. **通常只需要设置少数几个关键指标，不需要全部设置**
3. **阈值设置需要根据实际系统性能和业务需求确定**
4. **系统规则的优先级高于普通的流控规则**
5. **建议在生产环境中谨慎使用，避免误触发影响业务**