# Sentinel 熔断降级规则参数详解

本文档详细介绍了 Sentinel 熔断降级规则中各个参数的含义和使用方法。

## 熔断降级规则结构

熔断降级规则是一个 JSON 数组，每个数组元素代表一条熔断降级规则：

```json
[
  {
    "resource": "degrade-rt",
    "grade": 0,
    "count": 1000,
    "timeWindow": 10,
    "minRequestAmount": 5,
    "statIntervalMs": 10000,
    "slowRatioThreshold": 0.6
  }
]
```

## 参数详解

### 1. resource（资源名）
- **类型**: String
- **必填**: 是
- **说明**: 熔断降级保护的资源名称，通常对应 `@SentinelResource` 注解中的 value 值
- **示例**: 
  ```json
  "resource": "degrade-rt"
  ```

### 2. grade（熔断策略）
- **类型**: Integer
- **必填**: 是
- **说明**: 熔断策略类型
- **可选值**:
  - `0`: 慢调用比例（响应时间）
  - `1`: 异常比例
  - `2`: 异常数
- **示例**:
  ```json
  "grade": 0  // 慢调用比例策略
  ```

### 3. count（阈值）
- **类型**: Double
- **必填**: 是
- **说明**: 根据不同熔断策略有不同的含义
- **不同策略含义**:
  - `grade=0`: 最大响应时间（毫秒），超过该时间的调用视为慢调用
  - `grade=1`: 异常比例阈值（0.0-1.0），如0.5表示50%
  - `grade=2`: 异常数阈值，如10表示10个异常
- **示例**:
  ```json
  "count": 1000  // 最大响应时间1000毫秒
  ```

### 4. timeWindow（熔断时长）
- **类型**: Integer
- **必填**: 是
- **说明**: 熔断器触发后的熔断时长（秒），在该时间内请求会直接失败
- **示例**:
  ```json
  "timeWindow": 10  // 熔断10秒
  ```

### 5. minRequestAmount（最小请求数）
- **类型**: Integer
- **必填**: 是
- **说明**: 在统计时间窗口内触发熔断的最小请求数，如果当前统计窗口内的请求数小于此值，即使达到熔断条件也不会触发熔断
- **示例**:
  ```json
  "minRequestAmount": 5  // 至少5个请求才会考虑熔断
  ```

### 6. statIntervalMs（统计时间窗口）
- **类型**: Integer
- **必填**: 是
- **说明**: 统计的时间窗口长度（毫秒），用于统计慢调用比例、异常比例等指标
- **示例**:
  ```json
  "statIntervalMs": 10000  // 10秒统计窗口
  ```

### 7. slowRatioThreshold（慢调用比例阈值）
- **类型**: Double
- **必填**: 否（仅 grade=0 时需要）
- **说明**: 慢调用比例阈值（0.0-1.0），超过该比例时触发熔断
- **示例**:
  ```json
  "slowRatioThreshold": 0.6  // 慢调用比例超过60%时熔断
  ```

## 规则示例解析

### 示例：慢调用比例熔断
```json
{
  "resource": "degrade-rt",
  "grade": 0,
  "count": 1000,
  "timeWindow": 10,
  "minRequestAmount": 5,
  "statIntervalMs": 10000,
  "slowRatioThreshold": 0.6
}
```
**解释**: 
- 对 `degrade-rt` 资源进行慢调用比例熔断
- 最大响应时间1000毫秒，超过此时间的调用视为慢调用
- 在10秒统计窗口内，如果慢调用比例超过60%且请求数不少于5个，则触发熔断
- 熔断持续10秒，期间请求直接失败

## 熔断策略详解

### 1. 慢调用比例策略（grade=0）
适用于响应时间过长的场景：
- 当接口响应时间超过设定阈值（count）时，视为慢调用
- 在统计时间窗口内，慢调用比例超过设定阈值（slowRatioThreshold）时触发熔断

### 2. 异常比例策略（grade=1）
适用于异常率较高的场景：
- 在统计时间窗口内，异常请求比例超过设定阈值（count）时触发熔断
- 例如：count=0.5 表示异常率超过50%时熔断

### 3. 异常数策略（grade=2）
适用于异常次数较多的场景：
- 在统计时间窗口内，异常请求数超过设定阈值（count）时触发熔断
- 例如：count=10 表示10秒内异常次数超过10次时熔断

## 最佳实践

### 1. 合理设置统计时间窗口
- 根据业务特点选择合适的统计时间窗口
- 窗口太短可能导致熔断过于敏感，窗口太长可能导致问题发现不及时

### 2. 设置合适的熔断时长
- 熔断时长应足够让依赖服务恢复，但不宜过长影响用户体验
- 可根据服务恢复时间预估设置

### 3. 配置最小请求数
- 避免在请求量很少时触发熔断
- 根据实际业务情况设置合理的最小请求数

## 注意事项

1. **resource名称必须与代码中的@SentinelResource注解value值一致**
2. **不同熔断策略需要的参数不同，注意按需配置**
3. **熔断降级是保护自身服务的手段，通常在客户端（调用端）配置**
4. **熔断后会触发fallback方法，需要在代码中正确实现**
5. **timeWindow期间的请求会直接失败，不会真正调用下游服务**