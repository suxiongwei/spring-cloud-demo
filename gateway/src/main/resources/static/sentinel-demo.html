<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>服务功能演示</title>
  <link rel="preconnect" href="https://unpkg.com"/>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; }
    .header { padding:16px; background:#0f62fe; color:#fff; font-size:20px; text-align:center; }
    .container { display:flex; flex-wrap:wrap; padding:16px; gap:16px; }
    .left { flex:1 1 360px; min-width:320px; border:1px solid #e0e0e0; border-radius:8px; padding:16px; }
    .right { flex:2 1 540px; min-width:360px; border:1px solid #e0e0e0; border-radius:8px; padding:16px; }
    .section { margin-bottom:16px; }
    .btn { padding:8px 12px; margin-right:8px; margin-bottom:8px; border: none; border-radius:6px; background:#393; color:#fff; cursor:pointer; }
    .btn.secondary { background:#555; }
    .btn.danger { background:#d73636; }
    .input { padding:8px; border:1px solid #ddd; border-radius:6px; margin-right:8px; }
    .link { display:inline-block; margin-right:12px; color:#0f62fe; cursor:pointer; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .card { border:1px solid #eee; border-radius:6px; padding:12px; }
    .pre { background:#f7f7f7; padding:12px; border-radius:6px; max-height:200px; overflow:auto; white-space:pre; font-family:monospace; }
    .list { max-height:280px; overflow:auto; }
    .row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee; }
    .ellipsis { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    @media (max-width: 768px) { .container { flex-direction:column; } }
  </style>
</head>
<body>
  <div class="header">服务功能演示</div>
  <div id="app" class="container">
    <div class="left">
      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">QPS限流测试</div>
          <div style="margin-bottom:8px">
            <span style="margin-right:8px">次数</span>
            <input class="input" type="number" min="1" v-model.number="qpsTimes" style="width:30px"/>
            <button class="btn" @click="trigger('qps', qpsTimes)">QPS限流</button>
            <button class="btn secondary" @click="viewRule('qps')">查看规则</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">线程数限流测试</div>
          <div style="margin-bottom:8px">
            <span style="margin-right:8px">次数</span>
            <input class="input" type="number" min="1" v-model.number="threadTimes" style="width:30px"/>
            <button class="btn" @click="trigger('thread', threadTimes)">线程数限流</button>
            <button class="btn secondary" @click="viewRule('thread')">查看规则</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">热点参数限流测试</div>
          <div>
            <span style="margin-right:8px">用户ID</span>  
            <input class="input" v-model="hotUserId" placeholder="userId" style="width:50px"/>
            <span style="margin:0 8px 0 12px">商品ID</span>
            <input class="input" v-model="hotProductId" placeholder="productId" style="width:50px"/>
            <span style="margin:0 8px 0 12px">次数</span>
            <input class="input" type="number" min="1" v-model.number="hotTimes" placeholder="次数" style="width:20px"/>
            <button class="btn" @click="trigger('hot', hotTimes)">热点参数限流</button>
            <button class="btn secondary" @click="viewRule('hot')">查看规则</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">关联限流测试</div>
          <div style="margin-bottom:8px">
            <span style="margin-right:8px">写并发数</span>
            <input class="input" type="number" min="1" v-model.number="assocWriteConcurrent" style="width:30px"/>
            <span style="margin:0 8px 0 12px">读并发数</span>
            <input class="input" type="number" min="1" v-model.number="assocReadConcurrent" style="width:30px"/>
            <button class="btn" @click="testAssoc('write')">仅写并发</button>
            <button class="btn" @click="testAssoc('read')">仅读并发</button>
            <button class="btn" @click="testAssoc('both')">同时发起</button>
            <button class="btn secondary" @click="viewRule('assoc')">查看规则</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">链路限流测试</div>
          <div style="margin-bottom:8px">
            <span style="margin-right:8px">A并发数</span>
            <input class="input" type="number" min="1" v-model.number="linkAConcurrent" style="width:30px"/>
            <span style="margin:0 8px 0 12px">B并发数</span>
            <input class="input" type="number" min="1" v-model.number="linkBConcurrent" style="width:30px"/>
            <button class="btn" @click="testLink()">同时调用A与B</button>
            <button class="btn secondary" @click="viewRule('link')">查看规则</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">熔断降级测试</div>
          <div style="margin-bottom:8px">
            <span style="margin-right:8px">并发数</span>
            <input class="input" type="number" min="1" v-model.number="degradeConcurrent" style="width:30px"/>
            <span style="margin:0 8px 0 12px">次数</span>
            <input class="input" type="number" min="1" v-model.number="degradeTimes" style="width:30px"/>
            <button class="btn" @click="testDegrade()">触发熔断</button>
            <button class="btn secondary" @click="viewRule('degrade')">查看规则</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">黑白名单控制测试</div>
          <div style="margin-bottom:8px">
            <span style="margin-right:8px">用户类型</span>
            <input class="input" v-model="authUserType" placeholder="如 vip/black/normal" style="width:80px"/>
            <span style="margin:0 8px 0 12px">次数</span>
            <input class="input" type="number" min="1" v-model.number="authTimes" style="width:30px"/>
            <button class="btn" @click="testAuthority('white')">白名单测试</button>
            <button class="btn" @click="testAuthority('black')">黑名单测试</button>
            <button class="btn secondary" @click="viewRule('auth')">查看规则</button>
          </div>
        </div>
      </div>
      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">Seata TCC 采购演示</div>
          <div>
            <span style="margin-right:8px">用户ID</span>
            <input class="input" v-model="tccUserId" placeholder="userId" style="width:50px"/>
            <span style="margin:0 8px 0 12px">商品编码</span>
            <input class="input" v-model="tccCommodityCode" placeholder="commodityCode" style="width:80px"/>
            <span style="margin:0 8px 0 12px">数量</span>
            <input class="input" type="number" min="1" v-model.number="tccCount" style="width:40px"/>
            <button class="btn" @click="call(endpoint('tcc-ok'),'tcc-ok')">TCC采购成功</button>
            <button class="btn danger" @click="call(endpoint('tcc-fail'),'tcc-fail')">TCC采购失败</button>
          </div>
        </div>
      </div>
      <div class="section">
        <button class="btn danger" @click="reset">重置</button>
      </div>
      
    </div>
    <div class="right">
      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">操作记录</div>
          <div class="list">
            <div class="row" style="font-weight:600">
              <div style="width:10%">时间</div>
              <div style="width:5%">类型</div>
              <div style="width:5%">状态</div>
              <div style="width:5%">响应Code</div>
              <div style="width:5%">耗时</div>
              <div style="width:70%">响应Msg</div>
            </div>
            <div class="row" v-for="h in history" :key="h.id">
              <div style="width:10%">{{h.time}}</div>
              <div style="width:5%">{{h.type}}</div>
              <div style="width:5%">{{h.status}}</div>
              <div style="width:5%">{{h.code}}</div>
              <div style="width:5%">{{h.rt}}ms</div>
              <div style="width:70%" class="ellipsis" :title="h.msg">{{sliceStr(h.msg)}}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">限流统计</div>
          <div id="chart" style="width:100%;height:320px"></div>
        </div>
      </div>
      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">限流分类统计</div>
          <div id="chart2" style="width:100%;height:320px"></div>
        </div>
      </div>
      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">TCC分类统计</div>
          <div id="chart3" style="width:100%;height:320px"></div>
        </div>
      </div>
      <div class="section">
        <div class="card">
          <div style="margin-bottom:8px; font-weight:600">当前限流规则配置详情</div>
          <div class="pre">{{ ruleView }}</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const app = Vue.createApp({
      data(){
        return {
          qpsTimes: 1,
          threadTimes: 1,
          hotTimes: 1,
          hotUserId: '1001',
          hotProductId: '2002',
          assocWriteConcurrent: 10,
          assocReadConcurrent: 10,
          linkAConcurrent: 10,
          linkBConcurrent: 10,
          degradeConcurrent: 5,
          degradeTimes: 10,
          authUserType: 'normal',
          authTimes: 10,
          tccUserId: '1',
          tccCommodityCode: 'P0001',
          tccCount: 2,
          lastResponse:'',
          lastError:'',
          history:[],
          stat:{ qps:{ok:0,fail:0}, thread:{ok:0,fail:0}, hot:{ok:0,fail:0}, assoc:{ok:0,fail:0}, link:{ok:0,fail:0}, degrade:{ok:0,fail:0}, auth:{ok:0,fail:0}, tcc:{ok:0,fail:0} },
          chart:null,
          ruleView: '服务: service-order\n规则数据源: Nacos\n组: SENTINEL_GROUP\n点击上方“查看规则”获取当前场景规则内容'
          ,trendLabels: []
          ,trendSuccess: []
          ,trendFail: []
        }
      },
      mounted(){
        this.chartTrend = echarts.init(document.getElementById('chart'))
        this.chartCategory = echarts.init(document.getElementById('chart2'))
        this.chartTcc = echarts.init(document.getElementById('chart3'))
        this.renderChart()
        window.addEventListener('resize',()=>{ this.chartTrend && this.chartTrend.resize(); this.chartCategory && this.chartCategory.resize(); this.chartTcc && this.chartTcc.resize() })
      },
      methods:{
        formatTime(date){
          const pad = (n)=> String(n).padStart(2,'0')
          const msPad = (n)=> String(n).padStart(3,'0')
          const h = pad(date.getHours())
          const m = pad(date.getMinutes())
          const s = pad(date.getSeconds())
          const ms = msPad(date.getMilliseconds())
          return `${h}:${m}:${s}.${ms}`
        },
        sliceStr(s, len=200){
          if(!s) return ''
          const str = typeof s === 'string' ? s : JSON.stringify(s)
          return str.length > len ? (str.substring(0, len) + '...') : str
        },
        endpoint(t){
          if(t==='qps') return '/api/order/rateLimit/qps'
          if(t==='thread') return '/api/order/rateLimit/thread'
          if(t==='hot') return '/api/order/hotspot/param?userId='+encodeURIComponent(this.hotUserId)+'&productId='+encodeURIComponent(this.hotProductId)
          if(t==='assoc-write') return '/api/order/writeDb'
          if(t==='assoc-read') return '/api/order/readDb'
          if(t==='link-a') return '/api/order/entry/a'
          if(t==='link-b') return '/api/order/entry/b'
          if(t==='degrade') return '/api/order/degrade/rt'
          if(t==='auth-white') return '/api/order/authority/control?userType='+encodeURIComponent(this.authUserType)
          if(t==='auth-black') return '/api/order/authority/control/black?userType='+encodeURIComponent(this.authUserType)
          if(t==='tcc-ok') return '/api/business/purchase/tcc?userId='+encodeURIComponent(this.tccUserId)+'&commodityCode='+encodeURIComponent(this.tccCommodityCode)+'&count='+encodeURIComponent(this.tccCount)
          if(t==='tcc-fail') return '/api/business/purchase/tcc?userId='+encodeURIComponent(this.tccUserId)+'&commodityCode='+encodeURIComponent(this.tccCommodityCode)+'&count='+encodeURIComponent(this.tccCount)+'&fail=true'
          return '/'
        },
        async trigger(t, times=1){
          const url = this.endpoint(t)
          const tasks = []
          for(let i=0;i<times;i++){
            tasks.push(this.call(url, t))
          }
          await Promise.all(tasks)
        },
        async run10(t){
          const url = this.endpoint(t)
          const tasks = []
          for(let i=0;i<10;i++){
            tasks.push(this.call(url, t))
          }
          await Promise.all(tasks)
        },
        async call(url,type){
          try{
            const s = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now()
            const res = await axios.get(url)
            const payload = res.data
            const ok = payload && typeof payload === 'object' && 'code' in payload ? (payload.code === 200) : (res.status === 200)
            const t = this.formatTime(new Date())
            if(ok){
              this.lastResponse = JSON.stringify(payload)
              const code = (payload && typeof payload === 'object' && 'code' in payload) ? payload.code : res.status
              const msg = (payload && typeof payload === 'object' && 'msg' in payload) ? payload.msg : (res.statusText || '')
              const e = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now()
              const rt = Math.round(e - s)
              this.history.unshift({ id: Date.now()+Math.random(), time: t, type: this.typeLabel(type), status: '成功', code, msg, rt })
              this.stat[this.typeKey(type)].ok++
            }else{
              this.lastError = JSON.stringify(payload)
              const code = (payload && typeof payload === 'object' && 'code' in payload) ? payload.code : (res.status || 0)
              const msg = (payload && typeof payload === 'object' && 'msg' in payload) ? payload.msg : (res.statusText || '')
              const e = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now()
              const rt = Math.round(e - s)
              this.history.unshift({ id: Date.now()+Math.random(), time: t, type: this.typeLabel(type), status: '失败', code, msg, rt })
              this.stat[this.typeKey(type)].fail++
            }
          }catch(e){
            const payload = e.response ? e.response.data : null
            this.lastError = payload ? JSON.stringify(payload) : String(e)
            const t = this.formatTime(new Date())
            const code = (payload && typeof payload === 'object' && 'code' in payload) ? payload.code : (e.response ? e.response.status : 0)
            const msg = (payload && typeof payload === 'object' && 'msg' in payload) ? payload.msg : (e.message || '')
            const rt = 0
            this.history.unshift({ id: Date.now()+Math.random(), time: t, type: this.typeLabel(type), status: '失败', code, msg, rt })
            this.stat[this.typeKey(type)].fail++
          }
          const sumOk = this.stat.qps.ok + this.stat.thread.ok + this.stat.hot.ok + this.stat.assoc.ok + this.stat.link.ok + this.stat.degrade.ok + this.stat.auth.ok + (this.stat.tcc ? this.stat.tcc.ok : 0)
          const sumFail = this.stat.qps.fail + this.stat.thread.fail + this.stat.hot.fail + this.stat.assoc.fail + this.stat.link.fail + this.stat.degrade.fail + this.stat.auth.fail + (this.stat.tcc ? this.stat.tcc.fail : 0)
          const label = this.formatTime(new Date())
          this.trendLabels.push(label)
          this.trendSuccess.push(sumOk)
          this.trendFail.push(sumFail)
          const maxPoints = 50
          if(this.trendLabels.length > maxPoints){
            this.trendLabels.shift(); this.trendSuccess.shift(); this.trendFail.shift()
          }
          this.renderChart()
        },
        typeLabel(t){
          if(t==='qps') return 'QPS'
          if(t==='thread') return '线程'
          if(t==='hot') return '热点'
          if(t==='assoc-write') return '关联写'
          if(t==='assoc-read') return '关联读'
          if(t==='link-a') return '链路A'
          if(t==='link-b') return '链路B'
          if(t==='degrade') return '熔断'
          if(t==='auth-white') return '授权白'
          if(t==='auth-black') return '授权黑'
          if(t==='tcc-ok') return 'TCC成功'
          if(t==='tcc-fail') return 'TCC失败'
          return t
        },
        typeKey(t){
          if(t==='qps'||t==='thread'||t==='hot') return t
          if(t.startsWith('assoc')) return 'assoc'
          if(t.startsWith('link')) return 'link'
          if(t.startsWith('auth')) return 'auth'
          if(t==='degrade') return 'degrade'
          if(t.startsWith('tcc')) return 'tcc'
          return 'qps'
        },
        async testAssoc(mode){
          const tasks=[]
          if(mode==='write' || mode==='both'){
            const urlW = this.endpoint('assoc-write')
            for(let i=0;i<this.assocWriteConcurrent;i++){ tasks.push(this.call(urlW,'assoc-write')) }
          }
          if(mode==='read' || mode==='both'){
            const urlR = this.endpoint('assoc-read')
            for(let i=0;i<this.assocReadConcurrent;i++){ tasks.push(this.call(urlR,'assoc-read')) }
          }
          await Promise.all(tasks)
        },
        async testLink(){
          const tasks=[]
          const urlA = this.endpoint('link-a')
          const urlB = this.endpoint('link-b')
          for(let i=0;i<this.linkAConcurrent;i++){ tasks.push(this.call(urlA,'link-a')) }
          for(let i=0;i<this.linkBConcurrent;i++){ tasks.push(this.call(urlB,'link-b')) }
          await Promise.all(tasks)
        },
        async testDegrade(){
          const tasks=[]
          const url = this.endpoint('degrade')
          for(let i=0;i<this.degradeTimes;i++){
            for(let j=0;j<this.degradeConcurrent;j++){
              tasks.push(this.call(url,'degrade'))
            }
          }
          await Promise.all(tasks)
        },
        async testAuthority(kind){
          const tasks=[]
          const t = kind==='white' ? 'auth-white' : 'auth-black'
          const url = this.endpoint(t)
          for(let i=0;i<this.authTimes;i++){ tasks.push(this.call(url,t)) }
          await Promise.all(tasks)
        },
        async viewRule(t){
          const flowUrl = '/api/order/sentinel/rules/flow'
          const paramUrl = '/api/order/sentinel/rules/param-flow'
          const degradeUrl = '/api/order/sentinel/rules/degrade'
          const authorityUrl = '/api/order/sentinel/rules/authority'
          let candidates = []
          let kind = 'flow'
          if(t==='qps'){ candidates = ['rateLimit-qps','GET:/rateLimit/qps']; kind='flow' }
          else if(t==='thread'){ candidates = ['rateLimit-thread','GET:/rateLimit/thread']; kind='flow' }
          else if(t==='hot'){ candidates = ['hotspot-param','GET:/hotspot/param']; kind='param' }
          else if(t==='assoc'){ candidates = ['read-db','write-db']; kind='flow' }
          else if(t==='link'){ candidates = ['common-resource']; kind='flow' }
          else if(t==='degrade'){ candidates = ['degrade-rt']; kind='degrade' }
          else if(t==='auth'){ candidates = ['authority-control','authority-control-black']; kind='authority' }
          try{
            let resp = null
            for(const r of candidates){
              let url = flowUrl
              if(kind==='param') url = paramUrl
              else if(kind==='degrade') url = degradeUrl
              else if(kind==='authority') url = authorityUrl
              const res = await axios.get(url, { params:{ resource:r } })
              if(res.data && res.data.data && res.data.data.length){ resp = res; break }
            }
            if(resp){
              const payload = resp.data
              this.ruleView = JSON.stringify(payload.data, null, 2)
            }else{
              this.ruleView = '未找到规则，请在 Sentinel 控制台或 Nacos 中确认资源名与规则是否存在'
            }
          }catch(e){
            const payload = e.response ? e.response.data : null
            this.ruleView = payload ? JSON.stringify(payload, null, 2) : String(e)
          }
        },
        renderChart(){
          const option = {
            tooltip:{},
            legend:{ data:['成功趋势','失败趋势'] },
            xAxis:{ type:'category', data:this.trendLabels },
            yAxis:{ type:'value' },
            series:[
              { name:'成功趋势', type:'line', smooth:true, data:this.trendSuccess, itemStyle:{ color:'#2ecc71' } },
              { name:'失败趋势', type:'line', smooth:true, data:this.trendFail, itemStyle:{ color:'#e74c3c' } }
            ]
          }
          this.chartTrend && this.chartTrend.setOption(option)
          const cats = ['QPS','线程数','热点','关联','链路','熔断','授权']
          const okArr = [this.stat.qps.ok, this.stat.thread.ok, this.stat.hot.ok, this.stat.assoc.ok, this.stat.link.ok, this.stat.degrade.ok, this.stat.auth.ok]
          const failArr = [this.stat.qps.fail, this.stat.thread.fail, this.stat.hot.fail, this.stat.assoc.fail, this.stat.link.fail, this.stat.degrade.fail, this.stat.auth.fail]
          const option2 = {
            tooltip:{},
            legend:{ data:['成功','失败'] },
            xAxis:{ type:'category', data:cats },
            yAxis:{ type:'value' },
            series:[
              { name:'成功', type:'bar', data:okArr, itemStyle:{ color:'#2ecc71' } },
              { name:'失败', type:'bar', data:failArr, itemStyle:{ color:'#e74c3c' } }
            ]
          }
          this.chartCategory && this.chartCategory.setOption(option2)

          const tccCats = ['TCC']
          const tccOkArr = [this.stat.tcc ? this.stat.tcc.ok : 0]
          const tccFailArr = [this.stat.tcc ? this.stat.tcc.fail : 0]
          const option3 = {
            tooltip:{},
            legend:{ data:['成功','失败'] },
            xAxis:{ type:'category', data:tccCats },
            yAxis:{ type:'value' },
            series:[
              { name:'成功', type:'bar', data:tccOkArr, itemStyle:{ color:'#2ecc71' } },
              { name:'失败', type:'bar', data:tccFailArr, itemStyle:{ color:'#e74c3c' } }
            ]
          }
          this.chartTcc && this.chartTcc.setOption(option3)
        },
        reset(){
          this.lastResponse=''
          this.lastError=''
          this.history=[]
          this.stat={ qps:{ok:0,fail:0}, thread:{ok:0,fail:0}, hot:{ok:0,fail:0}, assoc:{ok:0,fail:0}, link:{ok:0,fail:0}, degrade:{ok:0,fail:0}, auth:{ok:0,fail:0}, tcc:{ok:0,fail:0} }
          this.trendLabels=[]; this.trendSuccess=[]; this.trendFail=[]
          this.renderChart()
        }
      }
    })
    app.mount('#app')
  </script>
</body>
</html>

